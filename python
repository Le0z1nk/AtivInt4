from flask import Flask, request, jsonify
from flask_cors import CORS
import sqlite3

app = Flask(__name__)
CORS(app)

def init_db():
    con = sqlite3.connect('banco.db')
    cur = con.cursor()
    cur.execute("CREATE TABLE IF NOT EXISTS usuarios (id INTEGER PRIMARY KEY, usuario TEXT UNIQUE, senha TEXT)")
    cur.execute("CREATE TABLE IF NOT EXISTS feedbacks (id INTEGER PRIMARY KEY, usuario TEXT, mensagem TEXT)")
    con.commit()
    con.close()

@app.route('/cadastrar', methods=['POST'])
def cadastrar():
    data = request.get_json()
    usuario = data['usuario']
    senha = data['senha']
    try:
        con = sqlite3.connect('banco.db')
        cur = con.cursor()
        cur.execute("INSERT INTO usuarios (usuario, senha) VALUES (?, ?)", (usuario, senha))
        con.commit()
        con.close()
        return jsonify({"msg": "Usuário cadastrado com sucesso!"})
    except:
        return jsonify({"msg": "Usuário já existe."})

@app.route('/login', methods=['POST'])
def login():
    data = request.get_json()
    con = sqlite3.connect('banco.db')
    cur = con.cursor()
    cur.execute("SELECT * FROM usuarios WHERE usuario=? AND senha=?", (data['usuario'], data['senha']))
    res = cur.fetchone()
    con.close()
    return jsonify({"status": "ok" if res else "erro"})

@app.route('/feedback', methods=['POST'])
def feedback():
    data = request.get_json()
    con = sqlite3.connect('banco.db')
    cur = con.cursor()
    cur.execute("INSERT INTO feedbacks (usuario, mensagem) VALUES (?, ?)", (data['usuario'], data['mensagem']))
    con.commit()
    con.close()
    return jsonify({"status": "ok"})

@app.route('/feedbacks')
def listar_feedbacks():
    con = sqlite3.connect('banco.db')
    cur = con.cursor()
    cur.execute("SELECT usuario, mensagem FROM feedbacks")
    dados = [{"usuario": row[0], "mensagem": row[1]} for row in cur.fetchall()]
    con.close()
    return jsonify(dados)

if __name__ == '__main__':
    init_db()
    app.run(debug=True)
